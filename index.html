<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interplanetary Indexing and Content Routing</title>
    <style type="text/css">
        *, ::after, ::before {
  box-sizing: border-box;
  border: 0 solid;
        }
        body {
  font-family: inherit;
  line-height: inherit;
  margin: 0;
  font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif,Apple Color Emoji,Segoe UI Emoji;
}
        .p-8 {
  padding: 2rem;
}
html {
  font-family: ui-sans-serif,system-ui,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica Neue,Arial,Noto Sans,sans-serif,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol,Noto Color Emoji;
  line-height: 1.5;
  tab-size: 4;
}
table {
  border-collapse: collapse;
  width: 100%;
}
th {
    background-color: #dddddd;
}
td {
    background-color: #eeeeff;
}
td, th {
  border: 1px solid black;
  text-align: left;
  padding: 8px;
}
.to-pl-green {
  --tw-gradient-to: #4ef286;
}
.from-pl-blue {
  --tw-gradient-from: #008cff;
  --tw-gradient-stops: var(--tw-gradient-from),var(--tw-gradient-to,rgba(0,140,255,0));
}
.bg-gradient-to-r {
  background-image: linear-gradient(to right,var(--tw-gradient-stops));
}
.justify-between {
  justify-content: space-between;
}
.items-center {
  align-items: center;
}
.w-full {
  width: 100%;
}
.flex {
  display: flex;
}
.mt-6 {
  margin-top: 1.5rem;
}
.items-center {
  align-items: center;
}
.flex-col {
  flex-direction: column;
}
.min-h-screen {
  min-height: 100vh;
}
.flex {
  display: flex;
}
.flex-wrap {
  flex-wrap: wrap;
}
.max-w-4xl {
  max-width: 56rem;
}
.text-white {
  --tw-text-opacity: 1;
  color: rgba(255,255,255,var(--tw-text-opacity));
}
.text-3xl {
  font-size: 1.875rem;
  line-height: 2.25rem;
}
a {
  color: inherit;
  text-decoration: inherit;
}
.text-center {
  text-align: center;
}
.cursor-pointer {
  cursor: pointer;
}
h1, h2, h3, h4, h5, h6 {
  font-size: inherit;
  font-weight: inherit;
}
.font-bold {
  font-weight: 700;
}
.text-2xl {
  font-size: 1.5rem;
  line-height: 2rem;
}
.text-left {
  text-align: left;
}
#sb {
  margin: 1em;
  border: 0;
  border-bottom: 2px solid #ccc;
  font-weight: 500;
  font-size: 1.1em;
}
#lookup {
  color: white;
  padding: 0.6em;
  font-weight: 700;
  font-size: 1.1em;
  border: 1px solid #ccc;
}
    </style>
</head>
<body>
    <div class="flex flex-col items-center min-h-screen">
    <div class="flex w-full p-8 justify-between items-center bg-gradient-to-r from-pl-blue to-pl-green">
        <a href="/">
            <h1 class="text-3xl text-white text-center cursor-pointer">CID Contact - An Interplanetary Network Index</h1>
        </a>
    </div>
    <main>
        <div class="flex flex-wrap items-center justify-around  max-w-4xl mt-6 sm:w-full">
          <div class="flex flex-wrap flex-col w-100% items-left max-w-4xl mt-6 sm:w-full">
            <h2 class="text-2xl text-left font-bold">CID Lookup</h2>
            <h3 class="text-1xl text-left pt-2">
              <input id="sb" size="60" type="text" value="" placeholder="bafybeigvgzoolc3drupxhlevdp2ugqcrbcsqfmcek2zxiw5wctk3xjpjwy"/>
              <input id="lookup" type="button" value="Contact" class="bg-gradient-to-r from-pl-blue to-pl-green">
            </h3>
            <h3 class="text-1xl text-left pt-2" id="results"></h3>
        </div>
        <div class="flex flex-wrap flex-col w-100% items-left max-w-4xl mt-6 sm:w-full">
                <h2 class="text-2xl text-left font-bold">About</h2>
                <h3 class="text-1xl text-left pt-2">Content routing is the a term used to describe the problem of finding providers for a given piece of content. If you have a hash, or CID of some data, how do you find who has it?</h3>
                <h3 class="text-1xl text-left pt-2">In <a href="https://ipfs.io">IPFS</a>, a DHT is used as a decentralized answer to content routing. When considering the number of records present in Filecoin storage providers, it is clear that simply announcing these records to the DHT will place an undue burden on current DHT participants. It will take too much bandwidth and storage space to be practical.</h3>
                <h3 class="text-1xl text-left pt-2">This project encompasses a number of work streams aiming to increase the scalability and resilience of content routing. Network Index nodes can provide aggregated views of content routing, and harness the heterogeneity of network resources. Delegated Content Routing defines protocols for multiple content routing providers to be discovered and used safely, efficiently, and in a decentralized manner by clients.</h3>
            </div>
            <div class="flex flex-wrap flex-col w-100% items-left max-w-4xl mt-6 sm:w-full">
                <h2 class="text-2xl text-left font-bold">Status</h2>
                <aside>Last Updated: Mar 7th</aside>
                <h3 class="text-1xl text-left pt-2"><b><a href="https://github.com/filecoin-project/storetheindex/">Store The Index</a></b>: A network index node storing a mapping of CID to provider. Status: Full ingestion of 6 providers. More providers ongoing.</h3>
                <h3 class="text-1xl text-left pt-2"><b><a href="https://github.com/filecoin-project/index-provider">Index Provider</a></b>: A library for providing advertising provided content over the indexer '<a href="https://github.com/filecoin-project/index-provider/blob/docs/design/docs/design.md">ingestion protocol</a>'. Status: Running on some lotus production providers.</h3>
                <h3 class="text-1xl text-left pt-2"><b><a href="https://github.com/ipfs-shipyard/w3rc/">Retrieval Client</a></b>: A small client for retrieving content using a network indexer for content routing. Status: success for individual graphsync, bitswap retrievals</h3>
                <h3 class="text-1xl text-left pt-2"><b><a href="https://github.com/ipfs/go-delegated-routing">Delegated Routing</a></b>: A library for delegating content routing to an HTTP provider. Compatible with the store the index content routing API. Status: hydra nodes are running against production indexer.</h3>
                <h3 class="text-1xl text-left pt-2"><b><a href="https://hackmd.io/Ebmp0NkeSsSkz1R4Fd6EwA">Content Router Discovery Protocol</a></b>: A design for how delegated routers are automatically discovered and distributed in an IPFS environment. Status: Consensus</h3>
            </div>
        </div>
        <div class="flex flex-wrap flex-col w-100% items-left max-w-4xl mt-6 sm:w-full">
          <h2 class="text-2xl text-left font-bold">ðŸ—„ Store the Index weekly update from March 5th</h2>
          <ul>
            <li>
              Index provider has been <a href="https://github.com/filecoin-project/lotus/pull/7313">merged</a> into lotus master!
            </li>
            <li>
              We have confirmation that our gossipsub mesh is working as intended now that the mesh has stabilized
            </li>
            <li>
              Our transport protocols now have canonical IDs in the multicodecs table! bitswap is 0x900 and graphsync is 0x910.
            </li>
            <li>
              We fixed a host of bugs (<a href="https://github.com/filecoin-project/go-legs/pull/102">backpressure</a>, <a href="https://github.com/filecoin-project/storetheindex/pull/244">metrics</a>)
            </li>
            <li>
              @gammazero added <a href="https://github.com/filecoin-project/storetheindex/pull/247">periodic re-syncing</a>
            </li>
            <li>
              @Marco got some initial numbers from a <a href="https://github.com/filecoin-project/storetheindex/pull/245">load testing tool</a> indicating that the current configuration should have no problems ingesting 100,000's of cids per second.
            </li>
          </ul>
        </div>
        <div class="flex flex-wrap items-center justify-around  max-w-4xl mt-6 sm:w-full">
          <div class="flex flex-wrap flex-col w-100% items-left max-w-4xl mt-6 sm:w-full">
            <h2 class="text-2xl text-left font-bold">Find Us</h2>
            <h3 class="text-1xl text-left pt-2">At <a href='https://filecoinproject.slack.com/archives/C02T827T9N0'>#storetheindex</a> in the <a href='https://filecoin.io/slack'>filecoin community slack</a>.</h3>
          </div>
        </div>
    </main>
    </div>
</body>
<script type="text/javascript" src="cbor.js"></script>
<script type="text/javascript">
// varint decoding
var MSB = 0x80
  , REST = 0x7F

function readVarint(buf, offset) {
  var res    = 0
    , offset = offset || 0
    , shift  = 0
    , counter = offset
    , b
    , l = buf.length

  do {
    if (counter >= l || shift > 49) {
      readVarint.bytes = 0
      throw new RangeError('Could not decode varint')
    }
    b = buf[counter++]
    res += shift < 28
      ? (b & REST) << shift
      : (b & REST) * Math.pow(2, shift)
    shift += 7
  } while (b >= MSB)

  readVarint.bytes = counter - offset

  return res
}

  window.addEventListener('load', () => {
    document.getElementById('lookup').addEventListener('click', onSearch, false);
    document.getElementById('sb').addEventListener('keypress', (e) => {
      if (e.keyCode === 13) {
        onSearch();
      }
    }, false);
  })

  function joinPath(a, b) {
    return (a[a.length - 1] === "/" ? a : a + "/") + b
  }

  function onSearch() {
    let sb = document.getElementById('sb').value;
    if (sb == "") {
      sb = 'bafybeigvgzoolc3drupxhlevdp2ugqcrbcsqfmcek2zxiw5wctk3xjpjwy';
    }
    let p = '.'
    if (window.location != window.parent.location) {
      p = document.referrer
    }
    fetch(`${joinPath(p,'cid')}/${sb}`)
      .then((response) => {
        if (response.status >= 200 && response.status <= 299) {
          return response.json();
        } else if (response.status == 404) {
            throw "No results for this query";
        } else if (response.status == 400) {
            throw "Bad request - check that the CID is correct";
        } else {
            throw Error(response.statusText);
        }
      })
      .then(data => {
        let inner = '<table style="border:3px; border-style:solid; border-color:#287EC7; padding: 1em;"><tr><th>Found at</th>';
        const res = data.MultihashResults[0];
        let providers = {};
        for (let i = 0; i < res.ProviderResults.length; i++) {
          let provider = res.ProviderResults[i];
          if (providers[provider.Provider.ID] == undefined) {
            providers[provider.Provider.ID] = {}
          }
          providers[provider.Provider.ID][provider.ContextID] = provider;
        }
        const pids = Object.keys(providers)
        for (let i = 0; i < pids.length; i ++) {
          let pd = providers[pids[i]];
          inner += '<tr><td><h4>' + pids[i] + '</h4>';
          let addrs = '';
          let keys = {};
          let contexts = Object.keys(pd);
          for (let j = 0; j < contexts.length; j++) {
            let mdBytes = base64ToBytesArr(pd[contexts[j]].Metadata);
            while(mdBytes.length > 0) {
              let next = popProtocol(mdBytes);
              let name = next[0];
              mdBytes = next[1];
              let ctx = toContext(name, mdBytes);
              if (keys[name] == undefined) {
                keys[name] = [];
              }
              if (ctx[0] != "") {
                keys[name].push(ctx[0])
              }
              mdBytes = ctx[1];
              addrs = pd[contexts[j]].Provider.Addrs;
            }
          }
          inner += '<h5>Multiaddrs: ' + addrs +'</h5>'
          for (let j = 0; j < Object.keys(keys).length; j++) {
            inner += '<h5>' + Object.keys(keys)[j] + '</h5><ul>';
            for (let k = 0; k < keys[Object.keys(keys)[j]].length; k++) {
              inner += '<li>' + keys[Object.keys(keys)[j]][k] + '</li>';
            }
            inner += '</ul>'
          }
        }
        inner += '</td></tr></table>';
        document.getElementById('results').innerHTML = inner;
      })
      .catch(error => {
        let inner = '<p class="tab" style="border:3px; border-style:solid; border-color:#FF0000; padding: 1em; margin-bottom: 1em;">';
        inner += error;
        inner += '</p>';
        document.getElementById('results').innerHTML = inner;
      })
  }
  function popProtocol(buf) {
    let code = readVarint(buf, 0);
    buf = buf.slice(readVarint.bytes);

    if (code == 0x900) {
      return ['Bitswap', buf];
    } else if (code == 0x910 || code == 4128768) {
      return ['Graphsync', buf];
    } else {
      return [code, buf];
    }
  }
  function toContext(code, buf) {
    if (code == 'Graphsync') {
      try {
        const cbor = CBOR.decode(Uint8Array.from(buf).buffer);
        const cid = window.b2c(Uint8Array.from(cbor.PieceCID).subarray(1))
        let str = 'In piece ' + cid.toString()
        if (cbor.VerifiedDeal) {
          str += ' (Stored as verified data)';
        }
        if (cbor.FastRetrieval) {
          str += ' (Unsealed copy available)';
        }
        return [str, Uint8Array.from([])]
      } catch(e) {
        return ['Non-CBOR Context:' + e, buf]
      }
    }
    return ['', buf];
  }
  const abc = [..."ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"];
  function base64ToBytesArr(str) {
  let result = [];
  for(let i=0; i<str.length/4; i++) {
    let chunk = [...str.slice(4*i,4*i+4)]
    let bin = chunk.map(x=> abc.indexOf(x).toString(2).padStart(6,0)).join(''); 
    let bytes = bin.match(/.{1,8}/g).map(x=> +('0b'+x));
    result.push(...bytes.slice(0,3 - (str[4*i+2]=="=") - (str[4*i+3]=="=")));
  }
  return result;
}
</script>
</html>
